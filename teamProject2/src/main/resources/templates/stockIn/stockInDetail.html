<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì…ê³  ëª…ì„¸ì„œ</title>
  <link rel="stylesheet" href="/css/total.css" />
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <script src="/js/main.js"></script>
<script>
$(function() {

    $('.openModalBtn').on('click', function () {
        $('#requestOrder_modal').removeClass('hidden');
    });

    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
    $('#closeModalBtn, #cancelModalBtn').on('click', function () {
        $('#requestOrder_modal').addClass('hidden');
    });
    
    $(document).on('input', '.stiQtyInput', calcTotals);

    // í˜ì´ì§€ ë¡œë“œ í›„ í•œ ë²ˆ ê³„ì‚°
    $(document).ready(calcTotals);

    // "ë¶ˆìš©" ìƒíƒœ ì²´í¬ í›„ ìì¬ëª… ìë™ ì„¤ì •
    $('.blue_btn').on('click', function () {
        let hasDisuse = false;
        let disuseItemName = '';  // ìì¬ëª… ë³€ìˆ˜
        let stockList = [];

        $('#stockBody tr').each(function () {
            const status = $(this).find('td:eq(2) select option:selected').text().trim();
            const itemName = $(this).find('td:eq(1)').text();  // ìì¬ëª…
            const qty = $(this).find('.stiQtyInput').val();

            if (status === 'ë¶ˆìš©') {
                hasDisuse = true;
                disuseItemName = itemName;  // ìì¬ëª… ì €ì¥
                return false;  // ì²« ë²ˆì§¸ ë¶ˆìš© ì•„ì´í…œì—ì„œë§Œ ë©ˆì¶”ê¸°
            }
        });

        if (hasDisuse) {
            // ëª¨ë‹¬ ì—´ê¸° ë° ìì¬ëª… ìë™ ì…ë ¥
            $('#requestOrder_modal').removeClass('hidden');
            $('#requestOrder_modal input.readonly').eq(1).val(disuseItemName);  // ìì¬ëª… ì„¤ì •
        } else {
            // ì„œë²„ì— ì…ê³  ë“±ë¡ ìš”ì²­ í›„ ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™
            // ğŸ‘‰ ì—¬ê¸°ì— form ì „ì†¡ì´ë‚˜ fetch, AJAXë¡œ ì²˜ë¦¬
            location.href = '/stockIn/stockInList'; // ì˜ˆì‹œ
        }
    });

 // ë¶ˆìš© ì‚¬ìœ  ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
   $('#reasonSubmitBtn').on('click', function () {
	   
	var reasonCode = $('#reasonCode').val();
	   
	var ogubun = reasonCode.substring(0,3);
	var ono = reasonCode.substring(3);
	ono = "1"+ono;
	
    const reason = {
        rgubun: "STR",
        rname: "ë¶ˆìš©",
        rnote: $('#requestOrder_modal #reasonSelect option:selected').text(),  // ì¶”ê°€ì ì¸ ì‚¬ìœ 
        rdetail: $('#textarea').text(),  // ë¶ˆìš© ì‚¬ìœ 
        rstate: "N",
        sticd: ono,  // ì…ê³ ì½”ë“œ (í•„ìš” ì‹œ ë™ì  ë°”ì¸ë”©)	
        rcode: ono,
        ordcd: ono
    };

    $.ajax({
        type: "POST",
        url: "/stockIn/insertReason",  // ë¶ˆìš© ì‚¬ìœ  ì €ì¥ í›„ ìƒíƒœ ë³€ê²½í•˜ëŠ” API í˜¸ì¶œ
        contentType: "application/json",
        data: JSON.stringify(reason),
        success: function () {
            alert("ë¶ˆìš© ì‚¬ìœ  ì €ì¥ ë° ìƒíƒœ ë³€ê²½ ì™„ë£Œ");

            // ìƒíƒœê°€ "ì…ê³  ì™„ë£Œ"ë¡œ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            $('tr[data-ocode="' + reason.sticd + '"] .stockInBtn').hide();
            // ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            $('tr[data-ocode="' + reason.sticd + '"] td.stateText').text("ì…ê³  ì™„ë£Œ");
            
            // ì…ê³  ëª©ë¡ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
            window.location.href = '/stockIn/stockInList';  // ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
        },
        error: function (jqXHR, textStatus, errorThrown) {
            console.error('AJAX ìš”ì²­ ì˜¤ë¥˜:', textStatus, errorThrown);
            alert("ë¶ˆìš© ì‚¬ìœ  ì €ì¥ ë° ìƒíƒœ ë³€ê²½ ì²˜ë¦¬ ì‹¤íŒ¨");
            console.log('Response:', jqXHR.responseText);  // ì„œë²„ ì‘ë‹µ í™•ì¸
        }
				});

    		
	});
});
    
</script>

</head>
<body>

    <!-- header í—¤ë” ì‹œì‘ -->
    <header id="header">   

        <div class="h_wrap">
            <div class="h_inner center">
                <!-- header ë¡œê³  ì˜ì—­ -->
                <a href="index.html">
                    <h1 class="tit_h1">
                        <span class="blind">ERP SPARK</span>
                    </h1>
                </a>
                <!-- header ë¡œê³  ì˜ì—­ -->

                <!-- header gnb ì˜ì—­ -->
                <ul class="gnb">
                    <li>
                        <a href="#none">ìì¬ ê´€ë¦¬</a>
                    </li>
                    <li>
                        <a href="#none">ë°œì£¼ ê´€ë¦¬</a>
                    </li>
                    <li>
                        <a href="#none">ì…ê³  ê´€ë¦¬</a>
                    </li>
                    <li>
                        <a href="#none">ê³µê¸‰ì²˜ ê´€ë¦¬</a>
                    </li>
                    <li>
                        <a href="#none">ë§ˆì´í˜ì´ì§€</a>
                    </li>
                </ul>
                <!-- header gnb ì˜ì—­ -->

                <!-- header snb ì˜ì—­ -->
                <div class="snb">
                    <a href="#none">ê¹€ì² ìˆ˜ë‹˜</a>
                </div>
                <!-- header snb ì˜ì—­ -->
            </div>
        </div>
    </header>
    <!-- header í—¤ë” ë -->

    <!-- section ì»¨í…ì¸  ì˜ì—­ ì‹œì‘ -->
    <section id="section">
        <!-- ì£„ì¸¡ ë©”ë‰´ë°” ì‹œì‘ -->
        <aside id="aside">
            <ul>
                <li class="menu01">
                    <a href="#none">ìì¬ ê´€ë¦¬</a>
                    <ul class="menu02">
                        <li>
                            <a href="#none">ìì¬ ëª©ë¡</a>
                        </li>
                        <li>
                            <a href="#none">ìì¬ ë“±ë¡</a>
                        </li>
                    </ul>
                </li>

                <li class="menu01">
                    <a href="#none">ë°œì£¼ ê´€ë¦¬</a>
                    <ul class="menu02">
                        <li>
                            <a href="#none">ë°œì£¼ ëª©ë¡</a>
                        </li>
                        <li>
                            <a href="#none">ë°œì£¼ ì‹ ì²­</a>
                        </li>
                    </ul>
                </li>

                <li class="menu01">
                    <a href="#none">ì…ê³  ê´€ë¦¬</a>
                    <ul class="menu02">
                        <li>
                            <a href="#none">ì…ê³  ëª©ë¡</a>
                        </li>
                    </ul>
                </li>
                
                <li class="menu01">
                    <a href="#none">ê³µê¸‰ì²˜ ê´€ë¦¬</a>
                    <ul class="menu02">
                        <li>
                            <a href="#none">ê³µê¸‰ì²˜ ëª©ë¡</a>
                        </li>
                    </ul>
                </li>
                <li class="menu01">
                    <a href="#none">ë§ˆì´í˜ì´ì§€</a>
                </li>
            </ul>
        </aside>
        <!-- ì£„ì¸¡ ë©”ë‰´ë°” ë -->

        <!-- ì»¨í…ì¸  ì˜ì—­ ì‹œì‘ -->
        <div id="contents">            
            <div class="orderForm">
                <div class="ord_title">
                    <p>ì…ê³  ëª…ì„¸ì„œ</p>
                    <div class="ordR">
				        <p>ì…ê³ ì½”ë“œ : <span th:text="${reasonCode}"></span></p>
				        <p>ì…ê³ ì¼ì : <span th:text="${todayDate}"></span></p>
				      </div>
                </div>
                <div class="ord_top">
                    <div class="ord_tcon">
                        <p>ìˆ˜ì‹ ì²˜</p>
                        <table class="table3">
                            <tr>
                                <th>ë‹´ë‹¹ìëª…</th>
                                <td th:text="${receiverName}">ê¹€ì² ìˆ˜</td>
                            </tr>
                            <tr>
                                <th>ë‹´ë‹¹ë¶€ì„œ</th>
                                <td th:text="${receiverDept}">êµ¬ë§¤íŒ€</td>
                            </tr>
                            <tr>
                                <th>ì—°ë½ì²˜</th>
                                <td th:text="${receiverPhone}">010-1111-2222</td>
                            </tr>
                        </table>
                    </div>
                    <div class="ord_tcon">
                        <p>ê³µê¸‰ì²˜</p>
                        <table class="table3">
                            <tr>
						        <th>ê³µê¸‰ì²˜ëª…</th>
						        <td th:text="${supplier != null ? supplier.cname : ''}">ì œì´ì•¤í…Œí¬</td>
						    </tr>
						    <tr>
						        <th>ëŒ€í‘œì</th>
						        <td th:text="${supplier != null ? supplier.cowner : ''}">ê¹€ì§€í›ˆ</td>
						    </tr>
						    <tr>
						        <th>ì—°ë½ì²˜</th>
						        <td th:text="${supplier != null ? supplier.cphone : ''}">031-1111-2222</td>
						    </tr>
                        </table>
                    </div>
                </div>

                <div class="ord_content">
                     <table class="table1" id="stockTable">
				        <colgroup>
				          <col width="5%"/>
				          <col width="20%"/>
				          <col width="10%"/>
				          <col width="12%"/>
				          <col width="15%"/>
				          <col width="10%"/>
				          <col width="10%"/>
				          <col width="15%"/>
				          <col width="15%"/>
				        </colgroup>
                        <thead>
                            <tr>
                                <th>NO.</th>
                                <th>ìì¬ëª…</th>
                                <th>ê°€ìš©/ë¶ˆìš©</th>
                                <th>ì¶œí•˜ì°½ê³ ëª…</th>
                                <th>ë‹¨ê°€</th>
                                <th>ë°œì£¼ ìˆ˜ëŸ‰</th>
                                <th>ì…ê³  ìˆ˜ëŸ‰</th>
                                <th>ê³µê¸‰ê°€ì•¡</th>
                                <th>ì„¸ì•¡</th>
                            </tr>
                        </thead>
                        <tbody id="stockBody">
						  <tr th:each="item, stat : ${stockList}"
							  th:attr="data-ogubun=${item['ogubun']}, data-ono=${item['ono']}">
						    <td th:text="${stat.index + 1}"></td>
						    <td th:text="${item['iname']}"></td>
						    <td>
						      <select name="status">
						        <option th:selected="${item.status} == 'ê°€ìš©'">ê°€ìš©</option>
						        <option th:selected="${item.status} == 'ë¶ˆìš©'">ë¶ˆìš©</option>
						      </select>
						    </td>
						    <td>
							    <select name="ownm">
								  <option value="A ì°½ê³ " th:selected="${item['ownm'] == 'A ì°½ê³ '}">A ì°½ê³ </option>
								  <option value="B ì°½ê³ " th:selected="${item['ownm'] == 'B ì°½ê³ '}">B ì°½ê³ </option>
								</select>
						    </td>
						    <td class="price" th:text="${#numbers.formatInteger(item['ouprc'], 3, 'COMMA')} + 'ì›'"></td>
						    <td class="ordqty" th:text="${item['oqty']} + 'ê°œ'"></td>
						    <td class="stiqty">
						    	<input type="number" class="stiQtyInput" min="0" style="width: 60px;" />
  								<span class="unit">ê°œ</span>
  							</td>
						    <td class="supply" th:text="${#numbers.formatInteger(item['supply'], 3, 'COMMA')}"></td>
						    <td class="tax" th:text="${#numbers.formatInteger(item['tax'], 3, 'COMMA')}"></td>
						  </tr>
                            
                            <tr class="table_total">
							    <td colspan="5">í•©ê³„</td>
							    <td id="totalOrdQty" class="totalOrdQty"></td>
							    <td id="totalStiQty" class="totalStiQty"></td>
							    <td id="totalSupply" class="totalSupply"></td>
							    <td id="totalTax" class="totalTax"></td>
							</tr>
                        </tbody>
                    </table>
                </div>
                <div class="ord_ucon">
                    <table class="table3">
                        <tr>
                            <th>íŠ¹ì´ì‚¬í•­</th>
                            <td>
                                <textarea placeholder="íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="under_btn_wrap flex_center">
                <button type="button" class="blue_btn" id="insertBtn">ì…ê³ </button>		<!-- ë¶ˆìš© ì—†ìœ¼ë©´ ëª©ë¡, ë¶ˆìš© ìˆìœ¼ë©´ ë¶ˆìš© ì‚¬ìœ  ì…ë ¥ í™”ë©´ -->
                <button type="button" class="blue_border_btn" onClick="location='/stockIn/stockInList'">ëª©ë¡</button>
            </div>
        </div>
        <!-- ì»¨í…ì¸  ì˜ì—­ ë -->

        
    </section>
    <!-- section ì»¨í…ì¸  ì˜ì—­ ë -->

	<script>
	function calcTotals() {
		  let totalOrdQty = 0;
		  let totalStiQty = 0;
		  let totalSupply = 0;
		  let totalTax = 0;

		  $('#stockBody tr').each(function () {
		    const price = parseFloat($(this).find('.price').text().replace(/,/g, '')) || 0;
		    const ordqty = parseFloat($(this).find('.ordqty').text().replace(/,/g, '')) || 0;
		    const stiqty = parseFloat($(this).find('.stiQtyInput').val()) || 0;
		    const supply = price * stiqty;
		    const tax = supply * 0.1;

		    $(this).find('.supply').text(supply.toLocaleString());
		    $(this).find('.tax').text(tax.toLocaleString());

		    totalOrdQty += ordqty;
		    totalStiQty += stiqty;
		    totalSupply += supply;
		    totalTax += tax;
		  });

		  $('#totalOrdQty').text(totalOrdQty + 'ê°œ');
		  $('#totalStiQty').text(totalStiQty + 'ê°œ');
		  $('#totalSupply').text(totalSupply.toLocaleString());
		  $('#totalTax').text(totalTax.toLocaleString());
		}
	
	    $(document).on('input', '.price, .ordqty, .stiqty', calcTotals);
	    $(document).ready(calcTotals);
	    
	    
    </script>
    
    
    <!-- modal ì‹œì‘ -->
    <div id="requestOrder_modal" class="modal_container hidden">
        <div id="modal_con" class="modal_con2 center">
            <div class="modal_header">
                <h2>ë¶ˆìš© ì‚¬ìœ  ì…ë ¥</h2>
                <button type="button" id="closeModalBtn">
                    <img src="/images/modalClose_btn.svg" alt="ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼">
                </button>
            </div>
            <div class="modal_body">
                <div class="table_wrap">
                    <table class="table2" style="width: 100%;">
                    <tr>
                        <th>
                            <label>ì…ê³  ì½”ë“œ</label>
                        </th>
                        <td>
                            <input type="text" id="reasonCode" th:value="${reasonCode}" class="readonly" readonly>
                        </td>
                    </tr>
                    <tr>
                        <th>
                            <label>ìì¬ëª…</label>
                        </th>
                        <td>
                            <input type="text" th:value="${itemName}" class="readonly" readonly>
                        </td>
                    </tr>
                    <tr>
                        <th>
                            <label>ìˆ˜ëŸ‰</label>
                        </th>
                        <td>
                            <input type="text" placeholder="ì…ê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.">
                        </td>
                    </tr>
                    <tr>
                        <th>
                            <label>ë¶ˆìš© ì‚¬ìœ  ì„ íƒ</label>
                        </th>
                        <th class="select_box">
                            <select id="reasonSelect">
                                <option value="0" selected>ì…ê³  ì‚¬ìœ ë¥¼ ì„ íƒí•˜ì„¸ìš”.</option>
                                <option value="1">í¬ì¥ ì†ìƒ / íŒŒì† ë°œê²¬</option>
                                <option value="2">ìˆ˜ëŸ‰ ë¶€ì¡± / ê³¼ë‹¤</option>
                                <option value="3">ìœ íš¨ê¸°ê°„ ê²½ê³¼</option>
                                <option value="4">í’ˆì§ˆ ê²€ì‚¬ ë¶ˆí•©ê²©</option>
                                <option value="5">ë‚©ê¸°ì¼ ì´ˆê³¼ ì…ê³ </option>
                                <option value="6">ì˜ëª»ëœ í’ˆëª© ì…ê³ </option>
                                <option value="7">ê¸°íƒ€(ì§ì ‘ ì…ë ¥)</option>
                            </select>
                        </th>
                    </tr>
                    <tr>
                        <th>
                            <label>ë¶ˆìš© ì‚¬ìœ  ìƒì„¸ ì…ë ¥</label>
                        </th>
                        <td>
                            <textarea id="textarea" placeholder="ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                        </td>
                    </tr>
                </table>
                </div>
            </div>
            <div class="under_btn_wrap flex_center">
                <button type="button" class="blue_btn" id="reasonSubmitBtn">ì‹ ì²­</button>
                <button type="button" id="cancelModalBtn" class="blue_border_btn">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    <!-- modal ë -->

</body>
</html>
