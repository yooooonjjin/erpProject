<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì…ê³  ëª…ì„¸ì„œ</title>
  <link rel="stylesheet" href="/css/total.css" />
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <script src="/js/stockInDetail.js"></script>
  <script src="/js/main.js"></script>
<script>

</script>

</head>
<body>

    <!-- header í—¤ë” ì‹œì‘ -->
    <header id="header">   

        <div class="h_wrap">
            <div class="h_inner center">
                <!-- header ë¡œê³  ì˜ì—­ -->
                <a href="index.html">
                    <h1 class="tit_h1">
                        <span class="blind">ERP SPARK</span>
                    </h1>
                </a>
                <!-- header ë¡œê³  ì˜ì—­ -->

                <!-- header gnb ì˜ì—­ -->
                <ul class="gnb">
                    <li>
                        <a href="#none">ìì¬ ê´€ë¦¬</a>
                    </li>
                    <li>
                        <a href="#none">ë°œì£¼ ê´€ë¦¬</a>
                    </li>
                    <li>
                        <a href="#none">ì…ê³  ê´€ë¦¬</a>
                    </li>
                    <li>
                        <a href="#none">ê³µê¸‰ì²˜ ê´€ë¦¬</a>
                    </li>
                    <li>
                        <a href="#none">ë§ˆì´í˜ì´ì§€</a>
                    </li>
                </ul>
                <!-- header gnb ì˜ì—­ -->

                <!-- header snb ì˜ì—­ -->
                <div class="snb">
                    <a href="#none">ê¹€ì² ìˆ˜ë‹˜</a>
                </div>
                <!-- header snb ì˜ì—­ -->
            </div>
        </div>
    </header>
    <!-- header í—¤ë” ë -->

    <!-- section ì»¨í…ì¸  ì˜ì—­ ì‹œì‘ -->
    <section id="section">
        <!-- ì£„ì¸¡ ë©”ë‰´ë°” ì‹œì‘ -->
        <aside id="aside">
            <ul>
                <li class="menu01">
                    <a href="#none">ìì¬ ê´€ë¦¬</a>
                    <ul class="menu02">
                        <li>
                            <a href="#none">ìì¬ ëª©ë¡</a>
                        </li>
                        <li>
                            <a href="#none">ìì¬ ë“±ë¡</a>
                        </li>
                    </ul>
                </li>

                <li class="menu01">
                    <a href="#none">ë°œì£¼ ê´€ë¦¬</a>
                    <ul class="menu02">
                        <li>
                            <a href="#none">ë°œì£¼ ëª©ë¡</a>
                        </li>
                        <li>
                            <a href="#none">ë°œì£¼ ì‹ ì²­</a>
                        </li>
                    </ul>
                </li>

                <li class="menu01">
                    <a href="#none">ì…ê³  ê´€ë¦¬</a>
                    <ul class="menu02">
                        <li>
                            <a href="#none">ì…ê³  ëª©ë¡</a>
                        </li>
                    </ul>
                </li>
                
                <li class="menu01">
                    <a href="#none">ê³µê¸‰ì²˜ ê´€ë¦¬</a>
                    <ul class="menu02">
                        <li>
                            <a href="#none">ê³µê¸‰ì²˜ ëª©ë¡</a>
                        </li>
                    </ul>
                </li>
                <li class="menu01">
                    <a href="#none">ë§ˆì´í˜ì´ì§€</a>
                </li>
            </ul>
        </aside>
        <!-- ì£„ì¸¡ ë©”ë‰´ë°” ë -->

        <!-- ì»¨í…ì¸  ì˜ì—­ ì‹œì‘ -->
        <div id="contents">            
            <div class="orderForm">
                <div class="ord_title">
                    <p>ì…ê³  ëª…ì„¸ì„œ</p>
                    <div class="ordR">
				        <p>ì…ê³ ì½”ë“œ : <span th:text="${reasonCode}"></span></p>
				        <p>ì…ê³ ì¼ì : <span th:text="${todayDate}"></span></p>
				      </div>
                </div>
                <div class="ord_top">
                    <div class="ord_tcon">
                        <p>ìˆ˜ì‹ ì²˜</p>
                        <table class="table3">
                            <tr>
                                <th>ë‹´ë‹¹ìëª…</th>
                                <td th:text="${receiverName}">ê¹€ì² ìˆ˜</td>
                            </tr>
                            <tr>
                                <th>ë‹´ë‹¹ë¶€ì„œ</th>
                                <td th:text="${receiverDept}">êµ¬ë§¤íŒ€</td>
                            </tr>
                            <tr>
                                <th>ì—°ë½ì²˜</th>
                                <td th:text="${receiverPhone}">010-1111-2222</td>
                            </tr>
                        </table>
                    </div>
                    <div class="ord_tcon">
                        <p>ê³µê¸‰ì²˜</p>
                        <table class="table3">
                            <tr>
						        <th>ê³µê¸‰ì²˜ëª…</th>
						        <td th:text="${supplier != null ? supplier.cname : ''}">ì œì´ì•¤í…Œí¬</td>
						    </tr>
						    <tr>
						        <th>ëŒ€í‘œì</th>
						        <td th:text="${supplier != null ? supplier.cowner : ''}">ê¹€ì§€í›ˆ</td>
						    </tr>
						    <tr>
						        <th>ì—°ë½ì²˜</th>
						        <td th:text="${supplier != null ? supplier.cphone : ''}">031-1111-2222</td>
						    </tr>
                        </table>
                    </div>
                </div>

                <div class="ord_content">
                     <table class="table1" id="stockTable">
				        <colgroup>
				          <col width="5%"/>
				          <col width="15%"/>
				          <col width="10%"/>
				          <col width="15%"/>
				          <col width="15%"/>
				          <col width="10%"/>
				          <col width="15%"/>
				          <col width="15%"/>
				          <col width="10%"/>
				        </colgroup>
                        <thead>
                            <tr>
                                <th>NO.</th>
                                <th>ìì¬ëª…</th>
                                <th>ê°€ìš©/ë¶ˆìš©</th>
                                <th>ì¶œí•˜ì°½ê³ ëª…</th>
                                <th>ë‹¨ê°€</th>
                                <th>ë°œì£¼ ìˆ˜ëŸ‰</th>
                                <th>ì…ê³  ìˆ˜ëŸ‰</th>
                                <th>ê³µê¸‰ê°€ì•¡</th>
                                <th>ì„¸ì•¡</th>
                            </tr>
                        </thead>
                        <tbody id="stockBody">
						  <!-- stockListë¥¼ eachë¡œ ë°˜ë³µ, itemì€ Map<String, Object> íƒ€ì… ê°€ì • -->
						  <tr th:each="item, stat : ${stockList}"
						      th:attr="data-ogubun=${item['ogubun']}, data-ono=${item['ono']}">
						    
						    <!-- ì¸ë±ìŠ¤ (1ë¶€í„° ì‹œì‘) -->
						    <td th:text="${stat.index + 1}"></td>
						    
						    <!-- ìì¬ëª… -->
						    <td th:text="${item['iname']}"></td>
						    
						    <!-- ìƒíƒœ select -->
						    <td>
						      <select name="status" th:value="${item['status']}">
						        <option value="ê°€ìš©" th:selected="${item['status'] == 'ê°€ìš©'}">ê°€ìš©</option>
						        <option value="ë¶ˆìš©" th:selected="${item['status'] == 'ë¶ˆìš©'}">ë¶ˆìš©</option>
						      </select>
						    </td>
						    
						    <!-- ì°½ê³  select -->
						    <td>
						      <select name="ownm" th:value="${item['ownm']}">
						        <option value="A ì°½ê³ " th:selected="${item['ownm'] == 'A ì°½ê³ '}">A ì°½ê³ </option>
						        <option value="B ì°½ê³ " th:selected="${item['ownm'] == 'B ì°½ê³ '}">B ì°½ê³ </option>
						      </select>
						    </td>
						    
						    
						    <!-- ì£¼ë¬¸ ìˆ˜ëŸ‰ -->
						    <td class="ordqty" th:text="${item['oqty']} + 'ê°œ'"></td>
						    
						    <!-- ë‹¨ê°€ -->
						    <td class="price" th:text="|${#numbers.formatInteger(item['ouprc'], 3, 'COMMA')}ì›|">0ì›</td>
						    
						    
						    <!-- ì…ê³  ìˆ˜ëŸ‰ ì…ë ¥ -->
						    <td class="stiqty">
						      <input type="number" class="stiQtyInput" min="0" style="width: 60px;" />
						      <span class="unit">ê°œ</span>
						    </td>
						    
						    <!-- ê³µê¸‰ê°€ì•¡ -->
						    <td class="supply" th:text="${#numbers.formatInteger(item['supply'], 3, 'COMMA')}"></td>
						    
						    <!-- ì„¸ì•¡ -->
						    <td class="tax" th:text="${#numbers.formatInteger(item['tax'], 3, 'COMMA')}"></td>
						  </tr>
						  
						  <!-- í•©ê³„ í–‰ -->
						  <tr class="table_total">
						    <td colspan="5">í•©ê³„</td>
						    <td id="totalOrdQty" class="totalOrdQty"></td>
						    <td id="totalStiQty" class="totalStiQty"></td>
						    <td id="totalSupply" class="totalSupply"></td>
						    <td id="totalTax" class="totalTax"></td>
						  </tr>
						</tbody>
                    </table>
                </div>
                <div class="ord_ucon">
                    <table class="table3">
                        <tr>
                            <th>íŠ¹ì´ì‚¬í•­</th>
                            <td>
                                <textarea id="textarea" placeholder="íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="under_btn_wrap flex_center">
                <button type="button" class="blue_btn" id="insertBtn">ì…ê³ </button>		<!-- ë¶ˆìš© ì—†ìœ¼ë©´ ëª©ë¡, ë¶ˆìš© ìˆìœ¼ë©´ ë¶ˆìš© ì‚¬ìœ  ì…ë ¥ í™”ë©´ -->
                <button type="button" class="blue_border_btn" onClick="location='/stockIn/stockInList'">ëª©ë¡</button>
            </div>
        </div>
        <!-- ì»¨í…ì¸  ì˜ì—­ ë -->

         <script src="/js/stockInDetail.js"></script>
    </section>
    <!-- section ì»¨í…ì¸  ì˜ì—­ ë -->

	<script>
	
	$(function() {
		
		$('#insertBtn').on('click', function () {
		    console.log("âœ… insertBtn í´ë¦­ë¨");
		});

	    $('.openModalBtn').on('click', function () {
	        $('#requestOrder_modal').removeClass('hidden');
	    });

	    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
	    $('#closeModalBtn, #cancelModalBtn').on('click', function () {
	        $('#requestOrder_modal').addClass('hidden');
	    });
	    
	    $(document).on('input', '.stiQtyInput', calcTotals);

	    // í˜ì´ì§€ ë¡œë“œ í›„ í•œ ë²ˆ ê³„ì‚°
	    $(document).ready(calcTotals);

	    // "ë¶ˆìš©" ìƒíƒœ ì²´í¬ í›„ ìì¬ëª… ìë™ ì„¤ì •
	    $('.blue_btn').on('click', function () {
	    	console.log("âœ… ì…ê³  ë²„íŠ¼ í´ë¦­ë¨"); // ğŸ”¥ ì´ê²Œ ì•ˆ ì°íˆë©´ ë²„íŠ¼ ì—°ê²° ë¬¸ì œ!
	        
	        let hasDisuse = false;
	        let disuseItemName = "";

	        $('#stockBody tr').each(function () {
	            const status = $(this).find('td:eq(2) select option:selected').val();
	            const itemName = $(this).find('td:eq(1)').text().trim();

	            console.log("ğŸ” ìƒíƒœ:", status, "| ìì¬ëª…:", itemName);

	            if (status === 'ë¶ˆìš©') {
	                hasDisuse = true;
	                disuseItemName = itemName;
	                return false; // ë°˜ë³µ ì¤‘ë‹¨
	            }
	        });

	        if (hasDisuse) {
	            console.log("âš ï¸ ë¶ˆìš© ê°ì§€ â†’ ëª¨ë‹¬ ì—´ê¸°");
	            $('#requestOrder_modal').removeClass('hidden');
	            $('#requestOrder_modal input.readonly').eq(1).val(disuseItemName);
	        } else {
	            console.log("âœ… ê°€ìš©ë§Œ ìˆìŒ â†’ AJAX ì €ì¥ ì‹œì‘");

	            // ì—¬ê¸°ì— ì…ê³  ìˆ˜ëŸ‰ ìœ íš¨ì„± ê²€ì‚¬ + AJAX ì „ì†¡ ë¡œì§
	        
	        }
	    });

	 // ë¶ˆìš© ì‚¬ìœ  ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
	   $('#reasonSubmitBtn').on('click', function () {
		   
		var reasonCode = $('#reasonCode').val();
		   
		var ogubun = reasonCode.substring(0,3);
		var ono = reasonCode.substring(3);
		ono = "1"+ono;
		
	    const reason = {
	        rgubun: "STR",
	        rname: "ë¶ˆìš©",
	        rnote: $('#requestOrder_modal #reasonSelect option:selected').text(),  // ì¶”ê°€ì ì¸ ì‚¬ìœ 
	        rdetail: $('#textarea').text(),  // ë¶ˆìš© ì‚¬ìœ 
	        rstate: "N",
	        sticd: ono,  // ì…ê³ ì½”ë“œ (í•„ìš” ì‹œ ë™ì  ë°”ì¸ë”©)	
	        rcode: ono,
	        ordcd: ono
	    };

	    $.ajax({
	        type: "POST",
	        url: "/stockIn/insertReason",  // ë¶ˆìš© ì‚¬ìœ  ì €ì¥ í›„ ìƒíƒœ ë³€ê²½í•˜ëŠ” API í˜¸ì¶œ
	        contentType: "application/json",
	        data: JSON.stringify(reason),
	        success: function () {
	            alert("ë¶ˆìš© ì‚¬ìœ  ì €ì¥ ë° ìƒíƒœ ë³€ê²½ ì™„ë£Œ");

	            // ìƒíƒœê°€ "ì…ê³  ì™„ë£Œ"ë¡œ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
	            $('tr[data-ocode="' + reason.sticd + '"] .stockInBtn').hide();
	            // ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
	            $('tr[data-ocode="' + reason.sticd + '"] td.stateText').text("ì…ê³  ì™„ë£Œ");
	            
	            // ì…ê³  ëª©ë¡ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
	            window.location.href = '/stockIn/stockInList';  // ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
	        },
	        error: function (jqXHR, textStatus, errorThrown) {
	            console.error('AJAX ìš”ì²­ ì˜¤ë¥˜:', textStatus, errorThrown);
	            alert("ë¶ˆìš© ì‚¬ìœ  ì €ì¥ ë° ìƒíƒœ ë³€ê²½ ì²˜ë¦¬ ì‹¤íŒ¨");
	            console.log('Response:', jqXHR.responseText);  // ì„œë²„ ì‘ë‹µ í™•ì¸
	        }
					});

	    		
		});
	});
	    
	
	
	function calcTotals() {
		  let totalOrdQty = 0;
		  let totalStiQty = 0;
		  let totalSupply = 0;
		  let totalTax = 0;

		  $('#stockBody tr').each(function () {
		    const price = parseFloat($(this).find('.price').text().replace(/,/g, '')) || 0;
		    const ordqty = parseFloat($(this).find('.ordqty').text().replace(/,/g, '')) || 0;
		    const stiqty = parseFloat($(this).find('.stiQtyInput').val()) || 0;
		    const supply = price * stiqty;
		    const tax = supply * 0.1;

		    $(this).find('.supply').text(supply.toLocaleString());
		    $(this).find('.tax').text(tax.toLocaleString());

		    totalOrdQty += ordqty;
		    totalStiQty += stiqty;
		    totalSupply += supply;
		    totalTax += tax;
		  });

		  $('#totalOrdQty').text(totalOrdQty + 'ê°œ');
		  $('#totalStiQty').text(totalStiQty + 'ê°œ');
		  $('#totalSupply').text(totalSupply.toLocaleString());
		  $('#totalTax').text(totalTax.toLocaleString());
		}
	
	    $(document).on('input', '.price, .ordqty, .stiqty', calcTotals);
	    $(document).ready(calcTotals);
	    
	    
    </script>
    
    
    <!-- modal ì‹œì‘ -->
    <div id="requestOrder_modal" class="modal_container hidden">
        <div id="modal_con" class="modal_con2 center">
            <div class="modal_header">
                <h2>ë¶ˆìš© ì‚¬ìœ  ì…ë ¥</h2>
                <button type="button" id="closeModalBtn">
                    <img src="/images/modalClose_btn.svg" alt="ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼">
                </button>
            </div>
            <div class="modal_body">
                <div class="table_wrap">
                    <table class="table2" style="width: 100%;">
                    <tr>
                        <th>
                            <label>ì…ê³  ì½”ë“œ</label>
                        </th>
                        <td>
                            <input type="text" id="reasonCode" th:value="${reasonCode}" class="readonly" readonly>
                        </td>
                    </tr>
                    <tr>
                        <th>
                            <label>ìì¬ëª…</label>
                        </th>
                        <td>
                            <input type="text" th:value="${itemName}" class="readonly" readonly>
                        </td>
                    </tr>
                    <tr>
                        <th>
                            <label>ìˆ˜ëŸ‰</label>
                        </th>
                        <td>
                            <input type="text" placeholder="ì…ê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.">
                        </td>
                    </tr>
                    <tr>
                        <th>
                            <label>ë¶ˆìš© ì‚¬ìœ  ì„ íƒ</label>
                        </th>
                        <th class="select_box">
                            <select id="reasonSelect">
                                <option value="0" selected>ì…ê³  ì‚¬ìœ ë¥¼ ì„ íƒí•˜ì„¸ìš”.</option>
                                <option value="1">í¬ì¥ ì†ìƒ / íŒŒì† ë°œê²¬</option>
                                <option value="2">ìˆ˜ëŸ‰ ë¶€ì¡± / ê³¼ë‹¤</option>
                                <option value="3">ìœ íš¨ê¸°ê°„ ê²½ê³¼</option>
                                <option value="4">í’ˆì§ˆ ê²€ì‚¬ ë¶ˆí•©ê²©</option>
                                <option value="5">ë‚©ê¸°ì¼ ì´ˆê³¼ ì…ê³ </option>
                                <option value="6">ì˜ëª»ëœ í’ˆëª© ì…ê³ </option>
                                <option value="7">ê¸°íƒ€(ì§ì ‘ ì…ë ¥)</option>
                            </select>
                        </th>
                    </tr>
                    <tr>
                        <th>
                            <label>ë¶ˆìš© ì‚¬ìœ  ìƒì„¸ ì…ë ¥</label>
                        </th>
                        <td>
                            <textarea id="textarea" placeholder="ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                        </td>
                    </tr>
                </table>
                </div>
            </div>
            <div class="under_btn_wrap flex_center">
                <button type="button" class="blue_btn" id="reasonSubmitBtn">ì‹ ì²­</button>
                <button type="button" id="cancelModalBtn" class="blue_border_btn">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    <!-- modal ë -->

</body>
</html>
